@page "/info"
@using OdysejaAdmin.Data
@using System.Text.Json
@using System.Collections


<select @bind="_selectedCity"
        class="select">
    @foreach (var template in cities)
    {
        <option value=@template.id>@template.name</option>
    }
</select>

<input @bind="_newInfoName"
       type="text"
       class="input is-rounded"
       style="display: inline-block;"
       size="10px"/>

<button class="button is-primary"
        @onclick="AddInfo"
        style="display: inline-block;">
    Dodaj info
</button>

<br/>

<select @bind="SelectedInfo" class="select">
    @foreach (var info in infos)
    {
        <option value=@info.id>@info.infoName</option>
    }
</select>

<button class="button is-primary"
        @onclick="SaveInfo"
        style="display: inline-block;">
    Zapisz info
</button>

<br/>

<input @bind="_infoText"
       type="text"
       class="input is-rounded"
       size="50"/>

@code {
    private string _newInfoName = "";

    private int _selectedInfo = 0;

    private int SelectedInfo
    {
        get { return _selectedInfo; }
        set
        {
            _selectedInfo = value;
            _infoText = infos.Find(i => i.id == _selectedInfo).infoText;
            StateHasChanged();
        }
    }

    private String _infoText = "";

    private List<Info> infos = new List<Info>();

    private int _selectedCity = 0;
    private List<IdNameModel> cities = new List<IdNameModel>();

    protected async override void OnInitialized()
    {
        base.OnInitialized();
        await LoadCities();
        await LoadData();
    }

    private async Task LoadData()
    {
        string response = await RestService.Get("/info/" + _selectedCity);
        infos = JsonSerializer.Deserialize<List<Info>>(response);
        _selectedInfo = infos[0].id;
        StateHasChanged();
    }

    private async Task LoadCities()
    {
        string cities = await RestService.Get("/city");
        this.cities = JsonSerializer.Deserialize<List<IdNameModel>>(cities);
        StateHasChanged();
    }

    protected async Task AddInfo()
    {
        var info = new Info(0, _newInfoName, "", _selectedCity);
        await RestService.Post("/info", info);
        await LoadData();
    }

    private async Task SaveInfo()
    {
        var info = new Info(_selectedInfo, _newInfoName, _infoText, _selectedCity);
        await RestService.Put("/info", info);
        await LoadData();
    }

}